#!/bin/bash

# Pre-commit hook for parrot repository
# Handles both src/hub (Python) and src/sms-proxy (Go) directories

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit hooks...${NC}"

# Get the repository root
REPO_ROOT=$(git rev-parse --show-toplevel)

# Check if there are staged changes in src/hub
if git diff --cached --name-only | grep -q "^src/hub/"; then
    echo -e "${GREEN}Running checks for src/hub...${NC}"
    
    # Navigate to src/hub
    cd "$REPO_ROOT/src/hub"
    
    # Run pyrefly check
    echo "Running pyrefly check..."
    if ! pyrefly check --output-format min-text; then
        echo -e "${RED}pyrefly check failed!${NC}"
        exit 1
    fi
    
    # Run pytest
    echo "Running pytest..."
    if ! uv run python -m pytest -q; then
        echo -e "${RED}pytest failed!${NC}"
        exit 1
    fi
    
    # Run ruff and auto-fix
    echo "Running ruff..."
    uv run ruff check --fix --quiet .
    uv run ruff format --quiet .
    
    # Stage any changes made by ruff
    git add -u "$REPO_ROOT/src/hub"
fi

# Check if there are staged changes in src/sms-proxy
if git diff --cached --name-only | grep -q "^src/sms-proxy/"; then
    echo -e "${GREEN}Running checks for src/sms-proxy...${NC}"
    
    # Navigate to src/sms-proxy
    cd "$REPO_ROOT/src/sms-proxy"
    
    # Run go build
    echo "Running go build..."
    if ! go build -o bin; then
        echo -e "${RED}go build failed!${NC}"
        exit 1
    fi
    
    # Run go test
    echo "Running go test..."
    if ! go test ./...; then
        echo -e "${RED}go test failed!${NC}"
        exit 1
    fi
    
    # Run go fmt and stage any changes
    echo "Running go fmt..."
    go fmt ./...
    
    # Stage any changes made by go fmt
    git add -u "$REPO_ROOT/src/sms-proxy"
fi

echo -e "${GREEN}Pre-commit checks passed!${NC}"
exit 0